<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.0/examples/jsm/"
        }
      }
    </script>
    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      window.addEventListener("DOMContentLoaded", init);

      function init() {
        const width = window.innerWidth;
        const height = window.innerHeight;

        // レンダラーを作成
        const canvasElement = document.querySelector("#myCanvas");
        const renderer = new THREE.WebGLRenderer({ canvas: canvasElement });
        renderer.setSize(width, height);

        // シーンを作成
        const scene = new THREE.Scene();

        // カメラを作成
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 2000);
        camera.position.set(0, 50, 200);

        // カメラコントローラーを作成
        const controls = new OrbitControls(camera, canvasElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.2;

        // 光源を作成
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(10, 10, 10);
        scene.add(directionalLight);

        // パーティクルシステムを作成
        const particleCount = 500;
        const particles = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3);
        const colors = new Float32Array(particleCount * 3);

        for (let i = 0; i < particleCount; i++) {
          positions[i * 3] = (Math.random() - 0.5) * 20;
          positions[i * 3 + 1] = Math.random() * 10;
          positions[i * 3 + 2] = (Math.random() - 0.5) * 20;

          colors[i * 3] = 1.0;
          colors[i * 3 + 1] = 0.5 + Math.random() * 0.5;
          colors[i * 3 + 2] = 0.0;
        }

        particles.setAttribute("position", new THREE.BufferAttribute(positions, 3));
        particles.setAttribute("color", new THREE.BufferAttribute(colors, 3));

        const particleMaterial = new THREE.PointsMaterial({
          size: 0.5,
          vertexColors: true,
          map: new THREE.TextureLoader().load("https://threejs.org/examples/textures/particle2.png"),
          transparent: true,
          blending: THREE.AdditiveBlending,
          depthWrite: false,
        });

        const particleSystem = new THREE.Points(particles, particleMaterial);
        scene.add(particleSystem);

        // アニメーション関数
        function animate() {
          requestAnimationFrame(animate);

          const positions = particleSystem.geometry.attributes.position.array;
          for (let i = 0; i < particleCount; i++) {
            positions[i * 3 + 1] += 0.05;
            if (positions[i * 3 + 1] > 10) {
              positions[i * 3 + 1] = 0;
            }
          }
          particleSystem.geometry.attributes.position.needsUpdate = true;

          controls.update();
          renderer.render(scene, camera);
        }

        animate();
      }
    </script>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
  </body>
</html>
