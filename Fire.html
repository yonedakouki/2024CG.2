<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.167.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from "three";
        import { OrbitControls } from "three/addons/controls/OrbitControls.js";

        // サイズを指定
        const width = 960;
        const height = 540;

        // レンダラーを作成
        const canvasElement = document.querySelector("#myCanvas");
        const renderer = new THREE.WebGLRenderer({
            canvas: canvasElement,
        });
        renderer.setSize(width, height);

        // シーンを作成
        const scene = new THREE.Scene();

        // カメラを作成
        const camera = new THREE.PerspectiveCamera(45, width / height, 1, 5000);
        camera.position.set(300, 300, 1100);

        // カメラコントローラーを作成
        const controls = new OrbitControls(camera, canvasElement);

        // ライトを作成
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
        directionalLight.position.set(1, 1, 1).normalize();
        scene.add(directionalLight);

        // パーティクルのジオメトリとマテリアルを作成
        const particleCount = 1000;  // パーティクルの数
        const particles = new THREE.BufferGeometry();
        const positions = [];
        const colors = [];
        const sizes = [];
        const color = new THREE.Color();

        for (let i = 0; i < particleCount; i++) {
            // パーティクルの初期位置を設定
            positions.push(
                (Math.random() * 2 - 1) * 50,
                (Math.random() * 2 - 1) * 50,
                (Math.random() * 2 - 1) * 50
            );

            // 初期色をオレンジ色に設定
            color.setHSL(0.1, 1.0, 0.5);
            colors.push(color.r, color.g, color.b);

            // 初期サイズを設定
            sizes.push(10);
        }

        particles.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        particles.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        particles.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

        const particleMaterial = new THREE.ShaderMaterial({
            vertexShader: `
                attribute float size;
                varying vec3 vColor;
                void main() {
                    vColor = color;
                    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                    gl_PointSize = size * (300.0 / -mvPosition.z);
                    gl_Position = projectionMatrix * mvPosition;
                }
            `,
            fragmentShader: `
                varying vec3 vColor;
                void main() {
                    gl_FragColor = vec4(vColor, 1.0);
                }
            `,
            vertexColors: true, // これで色の情報を頂点から取得することを指定
            transparent: true
        });

        const particleSystem = new THREE.Points(particles, particleMaterial);
        scene.add(particleSystem);

        // アニメーション
        function animateParticles() {
            const time = Date.now() * 0.005;
            particleSystem.rotation.y = 0.01 * time;

            const sizes = particles.attributes.size.array;
            const colors = particles.attributes.color.array;

            for (let i = 0; i < particleCount; i++) {
                sizes[i] *= 0.98; // サイズを徐々に小さくする
                if (sizes[i] < 0.1) sizes[i] = 10; // サイズが小さくなったらリセット

                const alpha = sizes[i] / 10.0;
                colors[i * 3] = alpha; // 赤色を徐々に薄く
                colors[i * 3 + 1] = alpha * 0.5; // 緑色を徐々に薄く
                colors[i * 3 + 2] = 0; // 青色を徐々に消す
            }

            particles.attributes.size.needsUpdate = true;
            particles.attributes.color.needsUpdate = true;

            renderer.render(scene, camera);
            requestAnimationFrame(animateParticles);
        }

        animateParticles();
    </script>
</head>
<body>
    <canvas id="myCanvas"></canvas>
</body>
</html>
